{% extends "base.html" %}

{% block content %}
<!-- DAQ Overview Tab -->
<div class="tab-pane fade show active" id="overview">
  <h2>DAQ Overview</h2>

  <!-- Current run display -->
  <div class="mt-3 mb-3">
    <h6 class="text-white mb-1" style="font-size:1.1rem; font-weight:600;">
      Current run:&nbsp;<span id="run-display" style="color:#fff; font-weight:700;">None</span>
    </h6>
    <h6 class="text-white mb-0" style="font-size:1.1rem; font-weight:600;">
      Events this Run:&nbsp;<span id="events-display" style="color:#fff; font-weight:700;">0</span>
    </h6>
  </div>

  <!-- Control buttons -->
  <div class="mb-4 d-flex flex-wrap align-items-center gap-2">
    <select id="run-select" class="form-select me-3 d-none" style="width:auto;"></select>
    <button id="run-config-py" class="btn btn-success me-2 mb-2">Start Run</button>
    <button id="stop-sub-run" class="btn btn-warning me-2 mb-2">Stop Sub-Run</button>
    <button id="stop-run" class="btn btn-danger me-2 mb-2">Stop Run</button>
    <button id="restart-all" class="btn btn-danger me-2 mb-2">Restart All</button>
    <button id="take-pedestals" class="btn btn-secondary mb-2">Take Pedestals</button>
    <button id="git-reset" class="btn btn-secondary mb-2">Git Reset</button>
  </div>

    <div class="row" id="status-cards">
        <!-- Status cards populated dynamically -->
    </div>
    <hr class="my-4">

    <h3>HV Monitor</h3>
    <p class="text-muted" style="color:#fff;">Latest voltage and current readings from HV control system</p>
    <label for="hv-subrun-select" class="me-2">Subrun:</label>
          <select id="hv-subrun-select" class="form-select me-3" style="width:auto;">
            <option value="">(none)</option>
          </select>

    <div id="hv-voltage-plot" style="width:100%;height:400px;"></div>
    <div id="hv-current-plot" style="width:100%;height:400px;"></div>

    <script src="{{ url_for('static', filename='plotly.min.js') }}"></script>

</div>


<!-- Online QA Viewer Tab -->
<div class="tab-pane fade" id="png-viewer">
  <h2>Online QA</h2>

  <div class="row g-3">
    <div class="col-md-4">
      <label for="run-select-qa" class="form-label">Run:</label>
      <select id="run-select-qa" class="form-select">
        <option value="">Select run...</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="subrun-select" class="form-label">Subrun:</label>
      <select id="subrun-select" class="form-select" disabled>
        <option value="">Select subrun...</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="detector-select" class="form-label">Detector:</label>
      <select id="detector-select" class="form-select" disabled>
        <option value="">Select detector...</option>
      </select>
    </div>
  </div>

  <button id="load-pngs" class="btn btn-primary mt-3" disabled>Load Images</button>

  <div id="png-gallery" class="row mt-4"></div>
</div>



{% endblock %}

{% block scripts %}
<script>
// --- Live Screens JS ---
// {% for name in screens %}
// (function() {
//     var term = new Terminal();
//     term.open(document.getElementById("terminal-{{name}}"));
//     var socket = io();
//     socket.on("output-{{name}}", function(data) {
//         term.write(data);
//     });
//     term.onData(function(data) {
//         socket.emit("input-{{name}}", data);
//     });
//     socket.emit("start", {name: "{{name}}"});
// })();
// {% endfor %}

let run = null;
let lastSubrun = null;

// --- DAQ Overview JS ---
function updateStatus() {
    fetch("/status")
        .then(r => r.json())
        .then(data => {
            // Check subrun change
            const daq = data["daq_control"];
            const fields = daq?.fields || [];

            // Find the "Subrun" field (if it exists)
            const subrunField = fields.find(f => f.label === "Subrun");
            const subrun = subrunField ? subrunField.value : null;

            // Check if Subrun exists and changed
            if (subrun && subrun !== lastSubrun) {
                const select = document.getElementById("hv-subrun-select");

                // Update dropdown selection
                // First, check if this subrun already exists as an option
                let option = Array.from(select.options).find(opt => opt.value === subrun);
                if (!option) {
                    option = new Option(subrun, subrun);
                    select.add(option);
                }

                // Select it
                select.value = subrun;

                // Update tracker variable
                lastSubrun = subrun;
            }

            let container = document.getElementById("status-cards");
            container.innerHTML = "";
            data.forEach(info => {
                let details = info.fields.map(
                    f => `<p>${f.label}: ${f.value}</p>`
                ).join("");

                container.innerHTML += `
                  <div class="col-md-4 mb-3">
                    <div class="card text-white bg-${info.color}">
                      <div class="card-body">
                        <h5 class="card-title">${info.name}</h5>
                        <p class="card-text">Status: ${info.status}</p>
                        ${details}
                      </div>
                    </div>
                  </div>`;
            });

            // let container = document.getElementById("status-cards");
            // container.innerHTML = "";
            // Object.entries(data).forEach(([name, info]) => {
            //     let details = info.fields.map(
            //         f => `<p>${f.label}: ${f.value}</p>`
            //     ).join("");
            //
            //     container.innerHTML += `
            //       <div class="col-md-4 mb-3">
            //         <div class="card text-white bg-${info.color}">
            //           <div class="card-body">
            //             <h5 class="card-title">${name}</h5>
            //             <p class="card-text">Status: ${info.status}</p>
            //             ${details}
            //           </div>
            //         </div>
            //       </div>`;
            // });
        });
}

function showPopup(message, color) {
  const popup = document.createElement("div");
  popup.textContent = message;
  popup.style.position = "fixed";
  popup.style.top = "80px";
  popup.style.left = "50%";
  popup.style.transform = "translateX(-50%)";
  popup.style.background = color;
  popup.style.color = "#fff";
  popup.style.padding = "1em 2em";
  popup.style.borderRadius = "8px";
  popup.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
  popup.style.zIndex = "9999";
  popup.style.opacity = "1";
  popup.style.transition = "opacity 1s";

  document.body.appendChild(popup);

  setTimeout(() => {
    popup.style.opacity = "0";
    setTimeout(() => popup.remove(), 1000);
  }, 2500);
}


// STOP SUB-RUN button
document.getElementById("stop-sub-run").addEventListener("click", async () => {
  const ok = confirm("Are you sure you want to stop the *sub-run*?");
  if (!ok) return;   // <-- Cancel → do nothing

  const res = await fetch("/stop_sub_run", { method: "POST" });
  const data = await res.json();

  showPopup(data.message, "#dc7b35");

  run = null;
});


// STOP RUN button
document.getElementById("stop-run").addEventListener("click", async () => {
  const ok = confirm("Are you sure you want to STOP the run?");
  if (!ok) return;   // <-- Cancel → do nothing

  const res = await fetch("/stop_run", { method: "POST" });
  const data = await res.json();

  showPopup(data.message, "#dc3545");

  run = null;
});


// document.getElementById("stop-sub-run").addEventListener("click", async () => {
//   const res = await fetch("/stop_sub_run", { method: "POST" });
//   const data = await res.json();
//
//   // Create a fading popup
//   const popup = document.createElement("div");
//   popup.textContent = data.message;
//   popup.style.position = "fixed";
//   popup.style.top = "80px";
//   popup.style.left = "50%";
//   popup.style.transform = "translateX(-50%)";
//   popup.style.background = "#dc7b35";
//   popup.style.color = "#fff";
//   popup.style.padding = "1em 2em";
//   popup.style.borderRadius = "8px";
//   popup.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
//   popup.style.zIndex = "9999";
//   popup.style.opacity = "1";
//   popup.style.transition = "opacity 1s";
//
//   document.body.appendChild(popup);
//
//   run = null;
//
//   setTimeout(() => {
//     popup.style.opacity = "0";
//     setTimeout(() => popup.remove(), 1000);
//   }, 2500);
// });
//
//
// document.getElementById("stop-run").addEventListener("click", async () => {
//   const res = await fetch("/stop_run", { method: "POST" });
//   const data = await res.json();
//
//   // Create a fading popup
//   const popup = document.createElement("div");
//   popup.textContent = data.message;
//   popup.style.position = "fixed";
//   popup.style.top = "80px";
//   popup.style.left = "50%";
//   popup.style.transform = "translateX(-50%)";
//   popup.style.background = "#dc3545";
//   popup.style.color = "#fff";
//   popup.style.padding = "1em 2em";
//   popup.style.borderRadius = "8px";
//   popup.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
//   popup.style.zIndex = "9999";
//   popup.style.opacity = "1";
//   popup.style.transition = "opacity 1s";
//
//   document.body.appendChild(popup);
//
//   run = null;
//
//   setTimeout(() => {
//     popup.style.opacity = "0";
//     setTimeout(() => popup.remove(), 1000);
//   }, 2500);
// });

document.getElementById("restart-all").addEventListener("click", () => {
  if (!confirm("Are you sure you want to restart all DAQ components?")) return;
  fetch("/restart_all", { method: "POST" })
    .then(res => res.json())
    .then(data => alert(data.message))
    .catch(err => alert("Error: " + err));
});


// --- HV Plots ---
async function fetchHVData() {
    const run = document.getElementById("run-select").value;
    const subrun = document.getElementById("hv-subrun-select").value;
    const res = await fetch(`/hv_data?run=${encodeURIComponent(run)}&subrun=${encodeURIComponent(subrun)}`);
    const data = await res.json();
    if (!data || Object.keys(data).length === 0) return null;
    if (!data.success) throw data.message;
    return data;
}

async function updateHVPlots() {
    try {
        const data = await fetchHVData();
        if (!data) {
            console.log("No HV data available");
            return;
        }
        const time = data.time;

        const voltageTraces = Object.entries(data.voltage).map(([key, values]) => ({
            x: time,
            y: values,
            mode: 'lines',
            name: key
        }));

        const currentTraces = Object.entries(data.current).map(([key, values]) => ({
            x: time,
            y: values,
            mode: 'lines',
            name: key
        }));

        Plotly.newPlot('hv-voltage-plot', voltageTraces, {
            title: 'Voltage (V) vs Time',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Voltage (V)' },
            legend: { orientation: 'h' },
            template: 'plotly_dark'
        });

        Plotly.newPlot('hv-current-plot', currentTraces, {
            title: 'Current (µA) vs Time',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Current (µA)' },
            legend: { orientation: 'h' },
            template: 'plotly_dark'
        });

    } catch (err) {
        console.error("HV update failed:", err);
    }
}

async function loadRuns() {
    // Hack to only allow run_config_beam.json
  const runSelect = document.getElementById("run-select");
  runSelect.innerHTML = "";
  const opt = document.createElement("option");
  opt.value = "run_config_beam.json";
  opt.textContent = "run_config_beam.json";
  runSelect.appendChild(opt);
  runSelect.value = "run_config_beam.json";
  loadSubruns();
}

async function loadSubruns() {
  const runName = document.getElementById("run-select").value;
  const res = await fetch(`/get_subruns?run=${encodeURIComponent(runName)}`);
  const subruns = await res.json();
  const subrunSelect = document.getElementById("hv-subrun-select");
  const prev = subrunSelect.value;
  subrunSelect.innerHTML = "";
  subruns.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    subrunSelect.appendChild(opt);
  });
  if (subruns.includes(prev)) {
    subrunSelect.value = prev; // preserve selection
  } else if (subruns.length > 0) {
    subrunSelect.value = subruns[subruns.length - 1]; // default to latest
  }
}

// reload subruns periodically
setInterval(loadSubruns, 5000);

// reload subruns when run changes
document.getElementById("run-select").addEventListener("change", loadSubruns);

// initial load
loadRuns();

// take pedestals button handler
document.getElementById("take-pedestals").addEventListener("click", async () => {
  const res = await fetch("/take_pedestals", { method: "POST" });
  const data = await res.json();

  // Create a fading popup
    const popup = document.createElement("div");
    popup.textContent = data.message;
    popup.style.position = "fixed";
    popup.style.top = "80px";
    popup.style.left = "50%";
    popup.style.transform = "translateX(-50%)";
    popup.style.background = "#17a2b8";
    popup.style.color = "#fff";
    popup.style.padding = "1em 2em";
    popup.style.borderRadius = "8px";
    popup.style.boxShadow = "0 2px 8px rgba(0,0,0.2)";
    popup.style.zIndex = "9999";
    popup.style.opacity = "1";
    popup.style.transition = "opacity 1s";

    document.body.appendChild(popup);

    setTimeout(() => {
      popup.style.opacity = "0";
      setTimeout(() => popup.remove(), 1000);
    }, 2500);
});


// git reset button handler
document.getElementById("git-reset").addEventListener("click", async () => {
  // Run git reset
  const res = await fetch("/git_reset", { method: "POST" });
  const data = await res.json();

  // Create popup
  const popup = document.createElement("div");
  popup.textContent = data.message;
  popup.style.position = "fixed";
  popup.style.top = "80px";
  popup.style.left = "50%";
  popup.style.transform = "translateX(-50%)";
  popup.style.background = "#17a2b8";
  popup.style.color = "#fff";
  popup.style.padding = "1em 2em";
  popup.style.borderRadius = "8px";
  popup.style.boxShadow = "0 2px 8px rgba(0,0,0.2)";
  popup.style.zIndex = "9999";
  popup.style.opacity = "1";
  popup.style.transition = "opacity 1s";

  document.body.appendChild(popup);

  setTimeout(() => {
    popup.style.opacity = "0";
    setTimeout(() => popup.remove(), 1000);
  }, 2500);
});

document.getElementById("run-config-py").addEventListener("click", async function runConfigHandler() {

  // ----- STEP 1: Update run config -----
  const updateRes = await fetch("/update_run_config_py", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    {#body: JSON.stringify({ banco_position: bancoInput }),#}
  });

  const updateData = await updateRes.json();
  if (!updateData.success) {
    alert("Error updating run number: " + updateData.message);
    return;
  }

  console.log(updateData.message);

  // ----- STEP 2: Fetch updated config -----
  const configRes = await fetch("/get_config_py", { method: "GET" });
  const configData = await configRes.json();

  if (!configData.success) {
    alert("Could not load config: " + configData.message);
    return;
  }

  const runName = configData.run_name;

  // ----- STEP 3: Ask user for confirmation -----
  const confirmMsg =
    `Start run?\n\n` +
    `Run name: ${runName}\n` +
    `Are you sure you want to continue?`;

  const confirmRun = confirm(confirmMsg);
  if (!confirmRun) return;

  // ----- STEP 4: Start the run -----
  const res = await fetch("/run_config_py", { method: "POST" });
  const data = await res.json();

  // ----- STEP 5: Popup status -----
  const popup = document.createElement("div");
  popup.textContent = data.message;
  popup.style.position = "fixed";
  popup.style.top = "80px";
  popup.style.left = "50%";
  popup.style.transform = "translateX(-50%)";
  popup.style.background = data.success ? "#28a745" : "#dc3545";
  popup.style.color = "#fff";
  popup.style.padding = "1em 2em";
  popup.style.borderRadius = "8px";
  popup.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
  popup.style.zIndex = "9999";
  popup.style.opacity = "1";
  popup.style.transition = "opacity 1s";
  document.body.appendChild(popup);
  setTimeout(() => {
    popup.style.opacity = "0";
    setTimeout(() => popup.remove(), 1000);
  }, 2500);

  // ----- STEP 6: Update displayed info -----
  if (data.success) {
    document.getElementById("run-display").textContent = data.run_name;

    await loadRuns();

    const runSelect = document.getElementById("run-select");
    runSelect.value = "run_config_beam.json";

    await loadSubruns();
    updateHVPlots();
  }
});



async function updateRunDisplay() {
  try {
    const res = await fetch("/get_config_py", { method: "GET" });
    const data = await res.json();

    if (!data.success) return;

    document.getElementById("run-display").textContent = data.run_name;

  } catch (err) {
    console.error("Error updating run display:", err);
  }
}

// Update every 5 seconds
setInterval(updateRunDisplay, 5000);

// Also load immediately on page load
updateRunDisplay();


async function updateRunEventsDisplay() {
    try {
        const res = await fetch("/get_run_events", { method: "GET" });
        const data = await res.json();

        if (!data.success) return;

        document.getElementById("events-display").textContent = data.total_events;
    } catch (err) {
        console.error("Error updating run events display:", err);
    }
}

// update every 5 seconds
setInterval(updateRunEventsDisplay, 5000);

updateRunEventsDisplay();

// --- PNG Viewer JS ---
async function fetchDirs(subdir = "") {
    const res = await fetch(`/list_analysis_dirs?subdir=${encodeURIComponent(subdir)}`);
    return await res.json();
}

// Populate first-level runs on load
document.addEventListener("DOMContentLoaded", async () => {
    const runSelect = document.getElementById("run-select-qa");
    const res = await fetchDirs();
    if (res.success) {
        res.subdirs.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d;
            opt.textContent = d;
            runSelect.appendChild(opt);
        });
    }
});

// Handle Run selection → populate Subruns
document.getElementById("run-select-qa").addEventListener("change", async (e) => {
    const run = e.target.value;
    const subrunSelect = document.getElementById("subrun-select");
    const detectorSelect = document.getElementById("detector-select");
    const loadBtn = document.getElementById("load-pngs");

    subrunSelect.innerHTML = '<option value="">Select subrun...</option>';
    detectorSelect.innerHTML = '<option value="">Select detector...</option>';
    subrunSelect.disabled = true;
    detectorSelect.disabled = true;
    loadBtn.disabled = true;

    if (!run) return;

    const res = await fetchDirs(run);
    if (res.success) {
        res.subdirs.forEach(d => {
            const opt = document.createElement("option");
            opt.value = `${run}/${d}`;
            opt.textContent = d;
            subrunSelect.appendChild(opt);
        });
        subrunSelect.disabled = false;
    }
});

// Handle Subrun selection → populate Detectors
document.getElementById("subrun-select").addEventListener("change", async (e) => {
    const subrun = e.target.value;
    const detectorSelect = document.getElementById("detector-select");
    const loadBtn = document.getElementById("load-pngs");

    detectorSelect.innerHTML = '<option value="">Select detector...</option>';
    detectorSelect.disabled = true;
    loadBtn.disabled = true;

    if (!subrun) return;

    const res = await fetchDirs(subrun);
    if (res.success) {
        res.subdirs.forEach(d => {
            const opt = document.createElement("option");
            opt.value = `${subrun}/${d}`;
            opt.textContent = d;
            detectorSelect.appendChild(opt);
        });
        detectorSelect.disabled = false;
    }
});

// Handle Detector selection → enable Load button
document.getElementById("detector-select").addEventListener("change", (e) => {
    document.getElementById("load-pngs").disabled = !e.target.value;
});

// Load PNGs
// Common function to load PNGs
async function loadPNGs() {
    const run_dir = document.getElementById("run-select-qa").value;
    if (!run_dir) return; // no alert, just wait until selected

    const subrun_dir = document.getElementById("subrun-select").value;
    if (!subrun_dir) return;

    const det_dir = document.getElementById("detector-select").value;
    if (!det_dir) return;

    const dir = osJoin(run_dir, subrun_dir.split('/').pop(), det_dir.split('/').pop());

    const res = await fetch(`/list_pngs?dir=${encodeURIComponent(dir)}`);
    const data = await res.json();
    const gallery = document.getElementById("png-gallery");
    gallery.innerHTML = "";

    if (!data.success) {
        gallery.innerHTML = `<p class="text-danger">Error: ${data.message}</p>`;
        return;
    }
    if (data.images.length === 0) {
        gallery.innerHTML = "<p>No PNGs found in this directory.</p>";
        return;
    }

    data.images.forEach(imgUrl => {
        const col = document.createElement("div");
        col.className = "col-md-3 mb-3";
        col.innerHTML = `
            <div class="card bg-dark text-white border-0">
                <img src="${imgUrl}" class="card-img-top"
                     style="object-fit:contain;max-height:200px;cursor:pointer;"
                     alt="PNG image">
            </div>
        `;
        gallery.appendChild(col);

        // Add click-to-enlarge behavior
        const img = col.querySelector("img");
        img.addEventListener("click", () => openFullscreenImage(imgUrl));
    });
}

// Helper: fullscreen modal for image
function openFullscreenImage(imgUrl) {
    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = "100vw";
    overlay.style.height = "100vh";
    overlay.style.background = "rgba(0, 0, 0, 0.9)";
    overlay.style.display = "flex";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";
    overlay.style.zIndex = 9999;
    overlay.style.cursor = "zoom-out";

    const img = document.createElement("img");
    img.src = imgUrl;
    img.style.maxWidth = "95%";
    img.style.maxHeight = "95%";
    img.style.borderRadius = "8px";
    img.style.boxShadow = "0 0 20px rgba(255,255,255,0.3)";
    img.alt = "Enlarged image";

    overlay.appendChild(img);
    document.body.appendChild(overlay);
    overlay.addEventListener("click", () => overlay.remove());
}

// Option 1: Keep button (optional, for manual refresh)
document.getElementById("load-pngs").addEventListener("click", loadPNGs);

// ✅ Option 2: Auto-load when detector changes
document.getElementById("detector-select").addEventListener("change", loadPNGs);


// Helper for joining paths safely
function osJoin(...parts) {
    return parts.map(p => p.replace(/^\/+|\/+$/g, "")).join("/");
}


setInterval(updateStatus, 1000);  // update every 1s
updateStatus();

updateHVPlots();
setInterval(updateHVPlots, 5000);  // update every 5s
</script>
{% endblock %}
